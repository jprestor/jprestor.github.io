var core=require("./core"),fs=require("fs"),path=require("path"),caller=require("./caller.js"),nodeModulesPaths=require("./node-modules-paths.js");module.exports=function(e,t){function f(e){if(n(e))return e;for(var t=0;t<a.length;t++){var r=e+a[t];if(n(r))return r}}function p(e){var t=path.join(e,"/package.json");if(n(t))try{var a=i(t,"UTF8"),o=JSON.parse(a);if(r.packageFilter&&(o=r.packageFilter(o,e)),o.main){("."===o.main||"./"===o.main)&&(o.main="index");var s=f(path.resolve(e,o.main));if(s)return s;var u=p(path.resolve(e,o.main));if(u)return u}}catch(l){}return f(path.join(e,"/index"))}function h(e,t){for(var n=nodeModulesPaths(t,r),i=0;i<n.length;i++){var a=n[i],o=f(path.join(a,"/",e));if(o)return o;var s=p(path.join(a,"/",e));if(s)return s}}if("string"!=typeof e)throw new TypeError("Path must be a string.");var r=t||{},n=r.isFile||function(e){try{var t=fs.statSync(e)}catch(r){if(r&&("ENOENT"===r.code||"ENOTDIR"===r.code))return!1;throw r}return t.isFile()||t.isFIFO()},i=r.readFileSync||fs.readFileSync,a=r.extensions||[".js"],o=r.basedir||path.dirname(caller());if(r.paths=r.paths||[],/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[\/\\])/.test(e)){var s=path.resolve(o,e);(".."===e||"/"===e.slice(-1))&&(s+="/");var u=f(s)||p(s);if(u)return u}else{var l=h(e,o);if(l)return l}if(core[e])return e;var c=new Error("Cannot find module '"+e+"' from '"+o+"'");throw c.code="MODULE_NOT_FOUND",c};