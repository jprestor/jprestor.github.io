var core=require("./core"),fs=require("fs"),path=require("path"),caller=require("./caller.js"),nodeModulesPaths=require("./node-modules-paths.js");module.exports=function(e,t,r){function f(t,r,i){t?n(t):r?n(null,r,i):d(c,function(t,r,i){if(t)n(t);else if(r)n(null,r,i);else{var a=new Error("Cannot find module '"+e+"' from '"+l+"'");a.code="MODULE_NOT_FOUND",n(a)}})}function p(e,t,r){function l(e,t,r){function c(r,c,p){if(s=c,r)return a(r);if(p&&s&&i.pathFilter){var h=path.relative(p,n),d=h.slice(0,h.length-e[0].length),m=i.pathFilter(s,t,d);if(m)return l([""].concat(u.slice()),path.resolve(p,m),s)}o(n,f)}function f(r,i){return r?a(r):i?a(null,n,s):void l(e.slice(1),t,s)}if(0===e.length)return a(null,void 0,r);var n=t+e[0],s=r;s?c(null,s):h(path.dirname(n),c)}var n=t,a=r;"function"==typeof n&&(a=n,n=void 0);var s=[""].concat(u);l(s,e,n)}function h(e,t){if(""===e||"/"===e)return t(null);if("win32"===process.platform&&/^\w:[\/\\]*$/.test(e))return t(null);if(/[\/\\]node_modules[\/\\]*$/.test(e))return t(null);var r=path.join(e,"package.json");o(r,function(n,a){return a?void s(r,function(n,a){n&&t(n);try{var o=JSON.parse(a)}catch(s){}o&&i.packageFilter&&(o=i.packageFilter(o,r)),t(null,o,e)}):h(path.dirname(e),t)})}function d(e,t,r){var n=r,a=t;"function"==typeof a&&(n=a,a=i["package"]);var u=path.join(e,"package.json");o(u,function(t,r){return t?n(t):r?void s(u,function(t,r){if(t)return n(t);try{var a=JSON.parse(r)}catch(o){}return i.packageFilter&&(a=i.packageFilter(a,u)),a.main?(("."===a.main||"./"===a.main)&&(a.main="index"),void p(path.resolve(e,a.main),a,function(t,r,i){if(t)return n(t);if(r)return n(null,r,i);if(!i)return p(path.join(e,"index"),i,n);var a=path.resolve(e,i.main);d(a,i,function(t,r,i){return t?n(t):r?n(null,r,i):void p(path.join(e,"index"),i,n)})})):void p(path.join(e,"/index"),a,n)}):p(path.join(e,"index"),a,n)})}function m(t,r){function a(r,i,a){return r?t(r):i?t(null,i,a):void d(path.join(n,e),void 0,o)}function o(e,n,i){return e?t(e):n?t(null,n,i):void m(t,r.slice(1))}if(0===r.length)return t(null,void 0);var n=r[0],i=path.join(n,e);p(i,void 0,a)}function v(e,t,r){m(r,nodeModulesPaths(t,i))}var n=r,i=t||{};if("function"==typeof i&&(n=i,i={}),"string"!=typeof e){var a=new TypeError("Path must be a string.");return process.nextTick(function(){n(a)})}var o=i.isFile||function(e,t){fs.stat(e,function(e,r){return e?"ENOENT"===e.code||"ENOTDIR"===e.code?t(null,!1):t(e):t(null,r.isFile()||r.isFIFO())})},s=i.readFile||fs.readFile,u=i.extensions||[".js"],l=i.basedir||path.dirname(caller());if(i.paths=i.paths||[],/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[\/\\])/.test(e)){var c=path.resolve(l,e);(".."===e||"/"===e.slice(-1))&&(c+="/"),/\/$/.test(e)&&c===l?d(c,i["package"],f):p(c,i["package"],f)}else v(e,l,function(t,r,i){if(t)n(t);else if(r)n(null,r,i);else{if(core[e])return n(null,e);var a=new Error("Cannot find module '"+e+"' from '"+l+"'");a.code="MODULE_NOT_FOUND",n(a)}})};