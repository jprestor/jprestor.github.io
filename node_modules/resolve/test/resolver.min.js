var path=require("path"),test=require("tape"),resolve=require("../");test("async foo",function(e){e.plan(10);var t=path.join(__dirname,"resolver");resolve("./foo",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"foo.js")),e.equal(i&&i.name,"resolve")}),resolve("./foo.js",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"foo.js")),e.equal(i&&i.name,"resolve")}),resolve("./foo",{basedir:t,"package":{main:"resolver"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"foo.js")),e.equal(i&&i.main,"resolver")}),resolve("./foo.js",{basedir:t,"package":{main:"resolver"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"foo.js")),e.equal(i.main,"resolver")}),resolve("foo",{basedir:t},function(r){e.equal(r.message,"Cannot find module 'foo' from '"+path.resolve(t)+"'"),e.equal(r.code,"MODULE_NOT_FOUND")})}),test("bar",function(e){e.plan(6);var t=path.join(__dirname,"resolver");resolve("foo",{basedir:t+"/bar"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"bar/node_modules/foo/index.js")),e.equal(i,void 0)}),resolve("foo",{basedir:t+"/bar"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"bar/node_modules/foo/index.js")),e.equal(i,void 0)}),resolve("foo",{basedir:t+"/bar","package":{main:"bar"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"bar/node_modules/foo/index.js")),e.equal(i,void 0)})}),test("baz",function(e){e.plan(4);var t=path.join(__dirname,"resolver");resolve("./baz",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"baz/quux.js")),e.equal(i.main,"quux.js")}),resolve("./baz",{basedir:t,"package":{main:"resolver"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"baz/quux.js")),e.equal(i.main,"quux.js")})}),test("biz",function(e){e.plan(24);var t=path.join(__dirname,"resolver/biz/node_modules");resolve("./grux",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"grux/index.js")),e.equal(i,void 0)}),resolve("./grux",{basedir:t,"package":{main:"biz"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"grux/index.js")),e.equal(i.main,"biz")}),resolve("./garply",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"garply/lib/index.js")),e.equal(i.main,"./lib")}),resolve("./garply",{basedir:t,"package":{main:"biz"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"garply/lib/index.js")),e.equal(i.main,"./lib")}),resolve("tiv",{basedir:t+"/grux"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"tiv/index.js")),e.equal(i,void 0)}),resolve("tiv",{basedir:t+"/grux","package":{main:"grux"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"tiv/index.js")),e.equal(i,void 0)}),resolve("tiv",{basedir:t+"/garply"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"tiv/index.js")),e.equal(i,void 0)}),resolve("tiv",{basedir:t+"/garply","package":{main:"./lib"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"tiv/index.js")),e.equal(i,void 0)}),resolve("grux",{basedir:t+"/tiv"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"grux/index.js")),e.equal(i,void 0)}),resolve("grux",{basedir:t+"/tiv","package":{main:"tiv"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"grux/index.js")),e.equal(i,void 0)}),resolve("garply",{basedir:t+"/tiv"},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"garply/lib/index.js")),e.equal(i.main,"./lib")}),resolve("garply",{basedir:t+"/tiv","package":{main:"tiv"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"garply/lib/index.js")),e.equal(i.main,"./lib")})}),test("quux",function(e){e.plan(2);var t=path.join(__dirname,"resolver/quux");resolve("./foo",{basedir:t,"package":{main:"quux"}},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"foo/index.js")),e.equal(i.main,"quux")})}),test("normalize",function(e){e.plan(2);var t=path.join(__dirname,"resolver/biz/node_modules/grux");resolve("../grux",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"index.js")),e.equal(i,void 0)})}),test("cup",function(e){e.plan(4);var t=path.join(__dirname,"resolver");resolve("./cup",{basedir:t,extensions:[".js",".coffee"]},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"cup.coffee"))}),resolve("./cup.coffee",{basedir:t},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"cup.coffee"))}),resolve("./cup",{basedir:t,extensions:[".js"]},function(r,n){e.equal(r.message,"Cannot find module './cup' from '"+path.resolve(t)+"'"),e.equal(r.code,"MODULE_NOT_FOUND")})}),test("mug",function(e){e.plan(3);var t=path.join(__dirname,"resolver");resolve("./mug",{basedir:t},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"mug.js"))}),resolve("./mug",{basedir:t,extensions:[".coffee",".js"]},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"/mug.coffee"))}),resolve("./mug",{basedir:t,extensions:[".js",".coffee"]},function(r,n){e.equal(n,path.join(t,"/mug.js"))})}),test("other path",function(e){e.plan(6);var t=path.join(__dirname,"resolver"),r=path.join(t,"bar"),n=path.join(t,"other_path");resolve("root",{basedir:r,paths:[n]},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"other_path/root.js"))}),resolve("lib/other-lib",{basedir:r,paths:[n]},function(r,n){r&&e.fail(r),e.equal(n,path.join(t,"other_path/lib/other-lib.js"))}),resolve("root",{basedir:r},function(t,n){e.equal(t.message,"Cannot find module 'root' from '"+path.resolve(r)+"'"),e.equal(t.code,"MODULE_NOT_FOUND")}),resolve("zzz",{basedir:r,paths:[n]},function(t,n){e.equal(t.message,"Cannot find module 'zzz' from '"+path.resolve(r)+"'"),e.equal(t.code,"MODULE_NOT_FOUND")})}),test("incorrect main",function(e){e.plan(1);var t=path.join(__dirname,"resolver"),r=path.join(t,"incorrect_main");resolve("./incorrect_main",{basedir:t},function(t,n,i){t&&e.fail(t),e.equal(n,path.join(r,"index.js"))})}),test("without basedir",function(e){e.plan(1);var t=path.join(__dirname,"resolver/without_basedir"),r=require(path.join(t,"main.js"));r(e,function(r,n,i){r?e.fail(r):e.equal(n,path.join(t,"node_modules/mymodule.js"))})}),test("#25: node modules with the same name as node stdlib modules",function(e){e.plan(1);var t=path.join(__dirname,"resolver/punycode");resolve("punycode",{basedir:t},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"node_modules/punycode/index.js"))})}),test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name',function(e){e.plan(2);var t=path.join(__dirname,"resolver");resolve("./foo",{basedir:path.join(t,"same_names")},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"same_names/foo.js"))}),resolve("./foo/",{basedir:path.join(t,"same_names")},function(r,n,i){r&&e.fail(r),e.equal(n,path.join(t,"same_names/foo/index.js"))})}),test("async: #121 - treating an existing file as a dir when no basedir",function(e){var t=path.basename(__filename);e.test("sanity check",function(r){r.plan(1),resolve("./"+t,function(t,n,i){t&&e.fail(t),r.equal(n,__filename,"sanity check")})}),e.test("with a fake directory",function(e){e.plan(4),resolve("./"+t+"/blah",function(r,n,i){e.ok(r,"there is an error"),e.notOk(n,"no result"),e.equal(r&&r.code,"MODULE_NOT_FOUND","error code matches require.resolve"),e.equal(r&&r.message,"Cannot find module './"+t+"/blah' from '"+__dirname+"'","can not find nonexistent module"),e.end()})}),e.end()}),test("async dot main",function(e){var t=new Date;e.plan(3),resolve("./resolver/dot_main",function(r,n){e.notOk(r),e.equal(n,path.join(__dirname,"resolver/dot_main/index.js")),e.ok(new Date-t<50,"resolve.sync timedout"),e.end()})}),test("async dot slash main",function(e){var t=new Date;e.plan(3),resolve("./resolver/dot_slash_main",function(r,n){e.notOk(r),e.equal(n,path.join(__dirname,"resolver/dot_slash_main/index.js")),e.ok(new Date-t<50,"resolve.sync timedout"),e.end()})});