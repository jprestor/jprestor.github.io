var path=require("path"),fs=require("fs"),test=require("tape"),resolve=require("../"),symlinkDir=path.join(__dirname,"resolver","symlinked","symlink");try{fs.unlinkSync(symlinkDir)}catch(err){}try{fs.symlinkSync("./_/symlink_target",symlinkDir,"dir")}catch(err){fs.symlinkSync(path.join(__dirname,"resolver","symlinked","_","symlink_target")+"\\",symlinkDir,"junction")}test("symlink",function(e){e.plan(1),resolve("foo",{basedir:symlinkDir,preserveSymlinks:!1},function(t,r,n){t&&e.fail(t),e.equal(r,path.join(__dirname,"resolver","symlinked","_","node_modules","foo.js"))})}),test("sync symlink when preserveSymlinks = true",function(e){e.plan(4),resolve("foo",{basedir:symlinkDir},function(t,r,n){e.ok(t,"there is an error"),e.notOk(r,"no result"),e.equal(t&&t.code,"MODULE_NOT_FOUND","error code matches require.resolve"),e.equal(t&&t.message,"Cannot find module 'foo' from '"+symlinkDir+"'","can not find nonexistent module")})}),test("sync symlink",function(e){var t=new Date;e.equal(resolve.sync("foo",{basedir:symlinkDir,preserveSymlinks:!1}),path.join(__dirname,"resolver","symlinked","_","node_modules","foo.js")),e.ok(new Date-t<50,"resolve.sync timedout"),e.end()}),test("sync symlink when preserveSymlinks = true",function(e){e["throws"](function(){resolve.sync("foo",{basedir:symlinkDir})},/Cannot find module 'foo'/),e.end()});