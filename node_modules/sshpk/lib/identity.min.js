function Identity(e){var t=this;if(assert.object(e,"options"),assert.arrayOfObject(e.components,"options.components"),this.components=e.components,this.componentLookup={},this.components.forEach(function(e){e.name&&!e.oid&&(e.oid=oids[e.name]),e.oid&&!e.name&&(e.name=unoids[e.oid]),void 0===t.componentLookup[e.name]&&(t.componentLookup[e.name]=[]),t.componentLookup[e.name].push(e)}),this.componentLookup.cn&&this.componentLookup.cn.length>0&&(this.cn=this.componentLookup.cn[0].value),assert.optionalString(e.type,"options.type"),void 0===e.type)1===this.components.length&&this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length?(this.type="host",this.hostname=this.componentLookup.dc.map(function(e){return e.value}).join(".")):this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.uid&&1===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.mail&&1===this.componentLookup.mail.length?(this.type="email",this.email=this.componentLookup.mail[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length?(this.type="user",this.uid=this.componentLookup.cn[0].value):this.type="unknown";else if(this.type=e.type,"host"===this.type)this.hostname=e.hostname;else if("user"===this.type)this.uid=e.uid;else{if("email"!==this.type)throw new Error("Unknown type "+this.type);this.email=e.email}}function globMatch(e,t){if("**"===e||"**"===t)return!0;var r=e.split("."),n=t.split(".");if(r.length!==n.length)return!1;for(var i=0;i<r.length;++i)if("*"!==r[i]&&"*"!==n[i]&&r[i]!==n[i])return!1;return!0}module.exports=Identity;var assert=require("assert-plus"),algs=require("./algs"),crypto=require("crypto"),Fingerprint=require("./fingerprint"),Signature=require("./signature"),errs=require("./errors"),util=require("util"),utils=require("./utils"),asn1=require("asn1"),DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i,oids={};oids.cn="2.5.4.3",oids.o="2.5.4.10",oids.ou="2.5.4.11",oids.l="2.5.4.7",oids.s="2.5.4.8",oids.c="2.5.4.6",oids.sn="2.5.4.4",oids.dc="0.9.2342.19200300.100.1.25",oids.uid="0.9.2342.19200300.100.1.1",oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(e){unoids[oids[e]]=e}),Identity.prototype.toString=function(){return this.components.map(function(e){return e.name.toUpperCase()+"="+e.value}).join(", ")};var NOT_PRINTABLE=/[^a-zA-Z0-9 '(),+.\/:=?-]/,NOT_IA5=/[^\x00-\x7f]/;Identity.prototype.toAsn1=function(e,t){e.startSequence(t),this.components.forEach(function(t){if(e.startSequence(asn1.Ber.Constructor|asn1.Ber.Set),e.startSequence(),e.writeOID(t.oid),t.value.match(NOT_IA5)){var r=new Buffer(t.value,"utf8");e.writeBuffer(r,asn1.Ber.Utf8String)}else t.value.match(NOT_PRINTABLE)?e.writeString(t.value,asn1.Ber.IA5String):e.writeString(t.value,asn1.Ber.PrintableString);e.endSequence(),e.endSequence()}),e.endSequence()},Identity.prototype.equals=function(e){if(!Identity.isIdentity(e,[1,0]))return!1;if(e.components.length!==this.components.length)return!1;for(var t=0;t<this.components.length;++t){if(this.components[t].oid!==e.components[t].oid)return!1;if(!globMatch(this.components[t].value,e.components[t].value))return!1}return!0},Identity.forHost=function(e){return assert.string(e,"hostname"),new Identity({type:"host",hostname:e,components:[{name:"cn",value:e}]})},Identity.forUser=function(e){return assert.string(e,"uid"),new Identity({type:"user",uid:e,components:[{name:"uid",value:e}]})},Identity.forEmail=function(e){return assert.string(e,"email"),new Identity({type:"email",email:e,components:[{name:"mail",value:e}]})},Identity.parseDN=function(e){assert.string(e,"dn");var t=e.split(","),r=t.map(function(e){e=e.trim();var t=e.indexOf("="),r=e.slice(0,t).toLowerCase(),n=e.slice(t+1);return{name:r,value:n}});return new Identity({components:r})},Identity.parseAsn1=function(e,t){var r=[];e.readSequence(t);for(var n=e.offset+e.length;e.offset<n;){e.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var i=e.offset+e.length;e.readSequence();var s,a=e.readOID(),o=e.peek();switch(o){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:s=e.readString(o);break;case asn1.Ber.Utf8String:s=e.readString(o,!0),s=s.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:s=e.readString(o,!0),s=s.toString("utf16le");break;default:throw new Error("Unknown asn1 type "+o)}r.push({oid:a,value:s}),e._offset=i}return e._offset=n,new Identity({components:r})},Identity.isIdentity=function(e,t){return utils.isCompatible(e,Identity,t)},Identity.prototype._sshpkApiVersion=[1,0],Identity._oldVersionDetect=function(e){return[1,0]};