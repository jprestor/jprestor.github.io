function readMPInt(e,t){return assert.strictEqual(e.peek(),asn1.Ber.Integer,t+" is not an Integer"),utils.mpNormalize(e.readString(asn1.Ber.Integer,!0))}function verify(e,t){var r=e.signatures.x509;assert.object(r,"x509 signature");var n=r.algo.split("-");if(n[0]!==t.type)return!1;var i=r.cache;if(void 0===i){var a=new asn1.BerWriter;writeTBSCert(e,a),i=a.buffer}var o=t.createVerify(n[1]);return o.write(i),o.verify(r.signature)}function Local(e){return asn1.Ber.Context|asn1.Ber.Constructor|e}function Context(e){return asn1.Ber.Context|e}function read(e,t){"string"==typeof e&&(e=new Buffer(e,"binary")),assert.buffer(e,"buf");var r=new asn1.BerReader(e);if(r.readSequence(),Math.abs(r.length-r.remain)>1)throw new Error("DER sequence does not contain whole byte stream");var n=r.offset;r.readSequence();var i=r.offset+r.length,a=i;if(r.peek()===Local(0)){r.readSequence(Local(0));var o=r.readInt();assert.ok(3>=o,"only x.509 versions up to v3 supported")}var s={};s.signatures={};var u=s.signatures.x509={};u.extras={},s.serial=readMPInt(r,"serial"),r.readSequence();var l=r.offset+r.length,c=r.readOID(),f=SIGN_ALGS[c];if(void 0===f)throw new Error("unknown signature algorithm "+c);if(r._offset=l,s.issuer=Identity.parseAsn1(r),r.readSequence(),s.validFrom=readDate(r),s.validUntil=readDate(r),s.subjects=[Identity.parseAsn1(r)],r.readSequence(),l=r.offset+r.length,s.subjectKey=pkcs8.readPkcs8(void 0,"public",r),r._offset=l,r.peek()===Local(1)&&(r.readSequence(Local(1)),u.extras.issuerUniqueID=e.slice(r.offset,r.offset+r.length),r._offset+=r.length),r.peek()===Local(2)&&(r.readSequence(Local(2)),u.extras.subjectUniqueID=e.slice(r.offset,r.offset+r.length),r._offset+=r.length),r.peek()===Local(3)){r.readSequence(Local(3));var p=r.offset+r.length;for(r.readSequence();r.offset<p;)readExtension(s,e,r);assert.strictEqual(r.offset,p)}assert.strictEqual(r.offset,i),r.readSequence(),l=r.offset+r.length;var h=r.readOID(),d=SIGN_ALGS[h];if(void 0===d)throw new Error("unknown signature algorithm "+h);r._offset=l;var m=r.readString(asn1.Ber.BitString,!0);0===m[0]&&(m=m.slice(1));var v=d.split("-");return u.signature=Signature.parse(m,v[0],"asn1"),u.signature.hashAlgorithm=v[1],u.algo=d,u.cache=e.slice(n,a),new Certificate(s)}function readDate(e){if(e.peek()===asn1.Ber.UTCTime)return utcTimeToDate(e.readString(asn1.Ber.UTCTime));if(e.peek()===asn1.Ber.GeneralizedTime)return gTimeToDate(e.readString(asn1.Ber.GeneralizedTime));throw new Error("Unsupported date format")}function readExtension(e,t,r){r.readSequence();var a,n=r.offset+r.length,i=r.readOID(),o=e.signatures.x509;o.extras.exts=[];var s;switch(r.peek()===asn1.Ber.Boolean&&(s=r.readBoolean()),i){case EXTS.basicConstraints:r.readSequence(asn1.Ber.OctetString),r.readSequence();var u=r.offset+r.length,l=!1;r.peek()===asn1.Ber.Boolean&&(l=r.readBoolean()),void 0===e.purposes&&(e.purposes=[]),l===!0&&e.purposes.push("ca");var c={oid:i,critical:s};r.offset<u&&r.peek()===asn1.Ber.Integer&&(c.pathLen=r.readInt()),o.extras.exts.push(c);break;case EXTS.extKeyUsage:r.readSequence(asn1.Ber.OctetString),r.readSequence(),void 0===e.purposes&&(e.purposes=[]);for(var f=r.offset+r.length;r.offset<f;){var p=r.readOID();e.purposes.push(EXTPURPOSE_REV[p]||p)}-1!==e.purposes.indexOf("serverAuth")&&-1===e.purposes.indexOf("clientAuth")?e.subjects.forEach(function(e){"host"!==e.type&&(e.type="host",e.hostname=e.uid||e.email||e.components[0].value)}):-1!==e.purposes.indexOf("clientAuth")&&-1===e.purposes.indexOf("serverAuth")&&e.subjects.forEach(function(e){"user"!==e.type&&(e.type="user",e.uid=e.hostname||e.email||e.components[0].value)}),o.extras.exts.push({oid:i,critical:s});break;case EXTS.keyUsage:r.readSequence(asn1.Ber.OctetString);var h=r.readString(asn1.Ber.BitString,!0),d=readBitField(h,KEYUSEBITS);d.forEach(function(t){void 0===e.purposes&&(e.purposes=[]),-1===e.purposes.indexOf(t)&&e.purposes.push(t)}),o.extras.exts.push({oid:i,critical:s,bits:h});break;case EXTS.altName:r.readSequence(asn1.Ber.OctetString),r.readSequence();for(var m=r.offset+r.length;r.offset<m;)switch(r.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:r.readSequence(),r._offset+=r.length;break;case ALTNAME.OID:r.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var v=r.readString(ALTNAME.RFC822Name);a=Identity.forEmail(v),e.subjects[0].equals(a)||e.subjects.push(a);break;case ALTNAME.DirectoryName:r.readSequence(ALTNAME.DirectoryName),a=Identity.parseAsn1(r),e.subjects[0].equals(a)||e.subjects.push(a);break;case ALTNAME.DNSName:var g=r.readString(ALTNAME.DNSName);a=Identity.forHost(g),e.subjects[0].equals(a)||e.subjects.push(a);break;default:r.readString(r.peek())}o.extras.exts.push({oid:i,critical:s});break;default:o.extras.exts.push({oid:i,critical:s,data:r.readString(asn1.Ber.OctetString,!0)})}r._offset=n}function utcTimeToDate(e){var t=e.match(UTCTIME_RE);assert.ok(t,"timestamps must be in UTC");var r=new Date,n=r.getUTCFullYear(),i=100*Math.floor(n/100),a=parseInt(t[1],10);return a+=50>n%100&&a>=60?i-1:i,r.setUTCFullYear(a,parseInt(t[2],10)-1,parseInt(t[3],10)),r.setUTCHours(parseInt(t[4],10),parseInt(t[5],10)),t[6]&&t[6].length>0&&r.setUTCSeconds(parseInt(t[6],10)),r}function gTimeToDate(e){var t=e.match(GTIME_RE);assert.ok(t);var r=new Date;return r.setUTCFullYear(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)),r.setUTCHours(parseInt(t[4],10),parseInt(t[5],10)),t[6]&&t[6].length>0&&r.setUTCSeconds(parseInt(t[6],10)),r}function zeroPad(e){for(var t=""+e;t.length<2;)t="0"+t;return t}function dateToUTCTime(e){var t="";return t+=zeroPad(e.getUTCFullYear()%100),t+=zeroPad(e.getUTCMonth()+1),t+=zeroPad(e.getUTCDate()),t+=zeroPad(e.getUTCHours()),t+=zeroPad(e.getUTCMinutes()),t+=zeroPad(e.getUTCSeconds()),t+="Z"}function sign(e,t){void 0===e.signatures.x509&&(e.signatures.x509={});var r=e.signatures.x509;if(r.algo=t.type+"-"+t.defaultHashAlgorithm(),void 0===SIGN_ALGS[r.algo])return!1;var n=new asn1.BerWriter;writeTBSCert(e,n);var i=n.buffer;r.cache=i;var a=t.createSign();return a.write(i),e.signatures.x509.signature=a.sign(),!0}function signAsync(e,t,r){void 0===e.signatures.x509&&(e.signatures.x509={});var n=e.signatures.x509,i=new asn1.BerWriter;writeTBSCert(e,i);var a=i.buffer;n.cache=a,t(a,function(e,t){return e?void r(e):(n.algo=t.type+"-"+t.hashAlgorithm,void 0===SIGN_ALGS[n.algo]?void r(new Error('Invalid signing algorithm "'+n.algo+'"')):(n.signature=t,void r()))})}function write(e,t){var r=e.signatures.x509;assert.object(r,"x509 signature");var n=new asn1.BerWriter;n.startSequence(),r.cache?(n._ensure(r.cache.length),r.cache.copy(n._buf,n._offset),n._offset+=r.cache.length):writeTBSCert(e,n),n.startSequence(),n.writeOID(SIGN_ALGS[r.algo]),r.algo.match(/^rsa-/)&&n.writeNull(),n.endSequence();var i=r.signature.toBuffer("asn1"),a=new Buffer(i.length+1);return a[0]=0,i.copy(a,1),n.writeBuffer(a,asn1.Ber.BitString),n.endSequence(),n.buffer}function writeTBSCert(e,t){var r=e.signatures.x509;assert.object(r,"x509 signature"),t.startSequence(),t.startSequence(Local(0)),t.writeInt(2),t.endSequence(),t.writeBuffer(utils.mpNormalize(e.serial),asn1.Ber.Integer),t.startSequence(),t.writeOID(SIGN_ALGS[r.algo]),t.endSequence(),e.issuer.toAsn1(t),t.startSequence(),t.writeString(dateToUTCTime(e.validFrom),asn1.Ber.UTCTime),t.writeString(dateToUTCTime(e.validUntil),asn1.Ber.UTCTime),t.endSequence();var n=e.subjects[0],i=e.subjects.slice(1);if(n.toAsn1(t),pkcs8.writePkcs8(t,e.subjectKey),r.extras&&r.extras.issuerUniqueID&&t.writeBuffer(r.extras.issuerUniqueID,Local(1)),r.extras&&r.extras.subjectUniqueID&&t.writeBuffer(r.extras.subjectUniqueID,Local(2)),i.length>0||"host"===n.type||void 0!==e.purposes&&e.purposes.length>0||r.extras&&r.extras.exts){t.startSequence(Local(3)),t.startSequence();var a=[];void 0!==e.purposes&&e.purposes.length>0&&(a.push({oid:EXTS.basicConstraints,critical:!0}),a.push({oid:EXTS.keyUsage,critical:!0}),a.push({oid:EXTS.extKeyUsage,critical:!0})),a.push({oid:EXTS.altName}),r.extras&&r.extras.exts&&(a=r.extras.exts);for(var o=0;o<a.length;++o){if(t.startSequence(),t.writeOID(a[o].oid),void 0!==a[o].critical&&t.writeBoolean(a[o].critical),a[o].oid===EXTS.altName){t.startSequence(asn1.Ber.OctetString),t.startSequence(),"host"===n.type&&t.writeString(n.hostname,Context(2));for(var s=0;s<i.length;++s)"host"===i[s].type?t.writeString(i[s].hostname,ALTNAME.DNSName):"email"===i[s].type?t.writeString(i[s].email,ALTNAME.RFC822Name):(t.startSequence(ALTNAME.DirectoryName),i[s].toAsn1(t),t.endSequence());t.endSequence(),t.endSequence()}else if(a[o].oid===EXTS.basicConstraints){t.startSequence(asn1.Ber.OctetString),t.startSequence();var u=-1!==e.purposes.indexOf("ca"),l=a[o].pathLen;t.writeBoolean(u),void 0!==l&&t.writeInt(l),t.endSequence(),t.endSequence()}else if(a[o].oid===EXTS.extKeyUsage)t.startSequence(asn1.Ber.OctetString),t.startSequence(),e.purposes.forEach(function(e){if("ca"!==e&&-1===KEYUSEBITS.indexOf(e)){var r=e;void 0!==EXTPURPOSE[e]&&(r=EXTPURPOSE[e]),t.writeOID(r)}}),t.endSequence(),t.endSequence();else if(a[o].oid===EXTS.keyUsage){if(t.startSequence(asn1.Ber.OctetString),void 0!==a[o].bits)t.writeBuffer(a[o].bits,asn1.Ber.BitString);else{var c=writeBitField(e.purposes,KEYUSEBITS);t.writeBuffer(c,asn1.Ber.BitString)}t.endSequence()}else t.writeBuffer(a[o].data,asn1.Ber.OctetString);t.endSequence()}t.endSequence(),t.endSequence()}t.endSequence()}function readBitField(e,t){for(var r=8*(e.length-1)-e[0],n={},i=0;r>i;++i){var a=1+Math.floor(i/8),o=7-i%8,s=1<<o,u=0!==(e[a]&s),l=t[i];u&&"string"==typeof l&&(n[l]=!0)}return Object.keys(n)}function writeBitField(e,t){var r=t.length,n=Math.ceil(r/8),i=8*n-r,a=new Buffer(1+n);a.fill(0),a[0]=i;for(var o=0;r>o;++o){var s=1+Math.floor(o/8),u=7-o%8,l=1<<u,c=t[o];if(void 0!==c){var f=-1!==e.indexOf(c);f&&(a[s]|=l)}}return a}module.exports={read:read,verify:verify,sign:sign,signAsync:signAsync,write:write};var assert=require("assert-plus"),asn1=require("asn1"),algs=require("../algs"),utils=require("../utils"),Key=require("../key"),PrivateKey=require("../private-key"),pem=require("./pem"),Identity=require("../identity"),Signature=require("../signature"),Certificate=require("../certificate"),pkcs8=require("./pkcs8"),SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4"};Object.keys(SIGN_ALGS).forEach(function(e){SIGN_ALGS[SIGN_ALGS[e]]=e}),SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5",SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"},ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)},EXTPURPOSE={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"},EXTPURPOSE_REV={};Object.keys(EXTPURPOSE).forEach(function(e){EXTPURPOSE_REV[EXTPURPOSE[e]]=e});var KEYUSEBITS=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"],UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/,GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;