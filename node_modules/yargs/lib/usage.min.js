var cliui=require("cliui"),decamelize=require("decamelize"),wsize=require("window-size");module.exports=function(e){function f(e){var t=0;return Array.isArray(e)||(e=Object.keys(e).map(function(t){return[e[t]]})),e.forEach(function(e){t=Math.max(e[0].length,t)}),c&&(t=Math.min(t,parseInt(.5*c,10))),t}function p(){var r=e.getOptions(),n=e.getDemanded();(Object.keys(r.alias)||[]).forEach(function(i){r.alias[i].forEach(function(a){u[a]&&t.describe(i,u[a]),n[a]&&e.demand(i,n[a].msg),~r["boolean"].indexOf(a)&&e["boolean"](i),~r.count.indexOf(a)&&e.count(i),~r.string.indexOf(a)&&e.string(i),~r.normalize.indexOf(a)&&e.normalize(i),~r.array.indexOf(a)&&e.array(i)})})}function h(e,t){var r="[default: ";if(void 0===e)return null;if(t)r+=t;else switch(typeof e){case"string":r+=JSON.stringify(e);break;case"object":r+=JSON.stringify(e);break;default:r+=e}return r+"]"}function d(){return wsize.width?Math.min(80,wsize.width):null}var t={},r=[];t.failFn=function(e){r.push(e)};var n=null,i=!0;t.showHelpOnFail=function(e,r){return"string"==typeof e?(r=e,e=!0):"undefined"==typeof e&&(e=!0),n=r,i=e,t},t.fail=function(t){if(r.length)r.forEach(function(e){e(t)});else{if(i&&e.showHelp("error"),t&&console.error(t),n&&(t&&console.error(""),console.error(n)),!e.getExitProcess())throw new Error(t);process.exit(1)}};var a;t.usage=function(e){a=e};var o=[];t.example=function(e,t){o.push([e,t||""])};var s=[];t.command=function(e,t){s.push([e,t||""])},t.getCommands=function(){return s};var u={};t.describe=function(e,r){"object"==typeof e?Object.keys(e).forEach(function(r){t.describe(r,e[r])}):u[e]=r},t.getDescriptions=function(){return u};var l;t.epilog=function(e){l=e};var c=d();t.wrap=function(e){c=e},t.help=function(){p();var t=e.getDemanded(),r=e.getOptions(),n=Object.keys(Object.keys(u).concat(Object.keys(t)).concat(Object.keys(r["default"])).reduce(function(e,t){return"_"!==t&&(e[t]=!0),e},{})),i=cliui({width:c,wrap:!!c});if(a){var d=a.replace(/\$0/g,e.$0);i.div(d+"\n")}s.length&&(i.div("Commands:"),s.forEach(function(e){i.div({text:e[0],padding:[0,2,0,2],width:f(s)+4},{text:e[1]})}),i.div());var m=(Object.keys(r.alias)||[]).concat(Object.keys(e.parsed.newAliases)||[]);n=n.filter(function(t){return!e.parsed.newAliases[t]&&m.every(function(e){return-1===(r.alias[e]||[]).indexOf(t)})});var v=n.reduce(function(e,t){return e[t]=[t].concat(r.alias[t]||[]).map(function(e){return(e.length>1?"--":"-")+e}).join(", "),e},{});if(n.length&&(i.div("Options:"),n.forEach(function(e){var n=v[e],a=u[e]||"",o=null;~r["boolean"].indexOf(e)&&(o="[boolean]"),~r.count.indexOf(e)&&(o="[count]"),~r.string.indexOf(e)&&(o="[string]"),~r.normalize.indexOf(e)&&(o="[string]"),~r.array.indexOf(e)&&(o="[array]");var s=[o,t[e]?"[required]":null,h(r["default"][e],r.defaultDescription[e])].filter(Boolean).join(" ");i.span({text:n,padding:[0,2,0,2],width:f(v)+4},a),s?i.div({text:s,padding:[0,0,0,2],align:"right"}):i.div()}),i.div()),o.length&&(i.div("Examples:"),o.forEach(function(t){t[0]=t[0].replace(/\$0/g,e.$0)}),o.forEach(function(e){i.div({text:e[0],padding:[0,2,0,2],width:f(o)+4},e[1])}),i.div()),l){var g=l.replace(/\$0/g,e.$0);i.div(g+"\n")}return i.toString()},t.showHelp=function(e){e=e||"error",console[e](t.help())},t.functionDescription=function(e,t){if(t)return t;var r=e.name?decamelize(e.name,"-"):"generated-value";return["(",r,")"].join("")};var m=null;return t.version=function(e,t,r){m=e},t.showVersion=function(){"function"==typeof m?console.log(m()):console.log(m)},t};