"use strict";function SymbolDef(e,t,r){this.name=r.name,this.orig=[r],this.scope=e,this.references=[],this.global=!1,this.mangled_name=null,this.undeclared=!1,this.index=t,this.id=SymbolDef.next_id++}SymbolDef.next_id=1,SymbolDef.prototype={unmangleable:function(e){return e||(e={}),this.global&&!e.toplevel||this.undeclared||!e.eval&&(this.scope.uses_eval||this.scope.uses_with)||e.keep_fnames&&(this.orig[0]instanceof AST_SymbolLambda||this.orig[0]instanceof AST_SymbolDefun)},mangle:function(e){var t=e.cache&&e.cache.props;if(this.global&&t&&t.has(this.name))this.mangled_name=t.get(this.name);else if(!this.mangled_name&&!this.unmangleable(e)){var r=this.scope,n=this.orig[0];!e.screw_ie8&&n instanceof AST_SymbolLambda&&(r=r.parent_scope);var i;this.defun&&(i=this.defun.variables.get(this.name))?this.mangled_name=i.mangled_name||i.name:this.mangled_name=r.next_mangled(e,this),this.global&&t&&t.set(this.name,this.mangled_name)}}},AST_Toplevel.DEFMETHOD("figure_out_scope",function(e){e=defaults(e,{cache:null,screw_ie8:!0});var t=this,r=t.parent_scope=null,n=new Dictionary,i=null,a=new TreeWalker(function(t,a){if(t instanceof AST_Catch){var o=r;return r=new AST_Scope(t),r.init_scope_vars(o),a(),r=o,!0}if(t instanceof AST_Scope){t.init_scope_vars(r);var o=r,s=i,u=n;return i=r=t,n=new Dictionary,a(),r=o,i=s,n=u,!0}if(t instanceof AST_LabeledStatement){var l=t.label;if(n.has(l.name))throw new Error(string_template("Label {name} defined twice",l));return n.set(l.name,l),a(),n.del(l.name),!0}if(t instanceof AST_With)for(var c=r;c;c=c.parent_scope)c.uses_with=!0;else if(t instanceof AST_Symbol&&(t.scope=r),t instanceof AST_Label&&(t.thedef=t,t.references=[]),t instanceof AST_SymbolLambda)i.def_function(t);else if(t instanceof AST_SymbolDefun)(t.scope=i.parent_scope).def_function(t);else if(t instanceof AST_SymbolVar||t instanceof AST_SymbolConst){if(i.def_variable(t),i!==r){t.mark_enclosed(e);var f=r.find_variable(t);t.thedef!==f&&(t.thedef=f,t.reference(e))}}else if(t instanceof AST_SymbolCatch)r.def_variable(t).defun=i;else if(t instanceof AST_LabelRef){var p=n.get(t.name);if(!p)throw new Error(string_template("Undefined label {name} [{line},{col}]",{name:t.name,line:t.start.line,col:t.start.col}));t.thedef=p}});t.walk(a);var o=null,a=(t.globals=new Dictionary,new TreeWalker(function(r,n){if(r instanceof AST_Lambda){var i=o;return o=r,n(),o=i,!0}if(r instanceof AST_LoopControl&&r.label)return r.label.thedef.references.push(r),!0;if(r instanceof AST_SymbolRef){var s=r.name;if("eval"==s&&a.parent()instanceof AST_Call)for(var u=r.scope;u&&!u.uses_eval;u=u.parent_scope)u.uses_eval=!0;var l=r.scope.find_variable(s);return r.scope instanceof AST_Lambda&&"arguments"==s&&(r.scope.uses_arguments=!0),l||(l=t.def_global(r)),r.thedef=l,r.reference(e),!0}}));t.walk(a),e.screw_ie8||t.walk(new TreeWalker(function(r,n){if(r instanceof AST_SymbolCatch){var i=r.name,a=r.thedef.references,o=r.thedef.defun,s=o.find_variable(i)||t.globals.get(i)||o.def_variable(r);return a.forEach(function(t){t.thedef=s,t.reference(e)}),r.thedef=s,!0}})),e.cache&&(this.cname=e.cache.cname)}),AST_Toplevel.DEFMETHOD("def_global",function(e){var t=this.globals,r=e.name;if(t.has(r))return t.get(r);var n=new SymbolDef(this,t.size(),e);return n.undeclared=!0,n.global=!0,t.set(r,n),n}),AST_Scope.DEFMETHOD("init_scope_vars",function(e){this.variables=new Dictionary,this.functions=new Dictionary,this.uses_with=!1,this.uses_eval=!1,this.parent_scope=e,this.enclosed=[],this.cname=-1}),AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments),this.uses_arguments=!1,this.def_variable(new AST_SymbolVar({name:"arguments",start:this.start,end:this.end}))}),AST_Symbol.DEFMETHOD("mark_enclosed",function(e){for(var t=this.definition(),r=this.scope;r&&(push_uniq(r.enclosed,t),e.keep_fnames&&r.functions.each(function(e){push_uniq(t.scope.enclosed,e)}),r!==t.scope);)r=r.parent_scope}),AST_Symbol.DEFMETHOD("reference",function(e){this.definition().references.push(this),this.mark_enclosed(e)}),AST_Scope.DEFMETHOD("find_variable",function(e){return e instanceof AST_Symbol&&(e=e.name),this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),AST_Scope.DEFMETHOD("def_function",function(e){this.functions.set(e.name,this.def_variable(e))}),AST_Scope.DEFMETHOD("def_variable",function(e){var t;return this.variables.has(e.name)?(t=this.variables.get(e.name),t.orig.push(e)):(t=new SymbolDef(this,this.variables.size(),e),this.variables.set(e.name,t),t.global=!this.parent_scope),e.thedef=t}),AST_Scope.DEFMETHOD("next_mangled",function(e){var t=this.enclosed;e:for(;;){var r=base54(++this.cname);if(is_identifier(r)&&!(e.except.indexOf(r)>=0)){for(var n=t.length;--n>=0;){var i=t[n],a=i.mangled_name||i.unmangleable(e)&&i.name;if(r==a)continue e}return r}}}),AST_Function.DEFMETHOD("next_mangled",function(e,t){for(var r=t.orig[0]instanceof AST_SymbolFunarg&&this.name&&this.name.definition(),n=r?r.mangled_name||r.name:null;;){var i=AST_Lambda.prototype.next_mangled.call(this,e,t);if(!n||n!=i)return i}}),AST_Symbol.DEFMETHOD("unmangleable",function(e){return this.definition().unmangleable(e)}),AST_Label.DEFMETHOD("unmangleable",function(){return!1}),AST_Symbol.DEFMETHOD("unreferenced",function(){return 0==this.definition().references.length&&!(this.scope.uses_eval||this.scope.uses_with)}),AST_Symbol.DEFMETHOD("undeclared",function(){return this.definition().undeclared}),AST_LabelRef.DEFMETHOD("undeclared",function(){return!1}),AST_Label.DEFMETHOD("undeclared",function(){return!1}),AST_Symbol.DEFMETHOD("definition",function(){return this.thedef}),AST_Symbol.DEFMETHOD("global",function(){return this.definition().global}),AST_Toplevel.DEFMETHOD("_default_mangler_options",function(e){return defaults(e,{eval:!1,except:[],keep_fnames:!1,screw_ie8:!0,sort:!1,toplevel:!1})}),AST_Toplevel.DEFMETHOD("mangle_names",function(e){e=this._default_mangler_options(e),e.except.push("arguments");var t=-1,r=[];e.cache&&this.globals.each(function(t){e.except.indexOf(t.name)<0&&r.push(t)});var n=new TreeWalker(function(i,a){if(i instanceof AST_LabeledStatement){var o=t;return a(),t=o,!0}if(i instanceof AST_Scope){var u=(n.parent(),[]);return i.variables.each(function(t){e.except.indexOf(t.name)<0&&u.push(t)}),void r.push.apply(r,u)}if(i instanceof AST_Label){var l;do l=base54(++t);while(!is_identifier(l));return i.mangled_name=l,!0}return e.screw_ie8&&i instanceof AST_SymbolCatch?void r.push(i.definition()):void 0});this.walk(n),r.forEach(function(t){t.mangle(e)}),e.cache&&(e.cache.cname=this.cname)}),AST_Toplevel.DEFMETHOD("compute_char_frequency",function(e){e=this._default_mangler_options(e);var t=new TreeWalker(function(t){t instanceof AST_Constant?base54.consider(t.print_to_string()):t instanceof AST_Return?base54.consider("return"):t instanceof AST_Throw?base54.consider("throw"):t instanceof AST_Continue?base54.consider("continue"):t instanceof AST_Break?base54.consider("break"):t instanceof AST_Debugger?base54.consider("debugger"):t instanceof AST_Directive?base54.consider(t.value):t instanceof AST_While?base54.consider("while"):t instanceof AST_Do?base54.consider("do while"):t instanceof AST_If?(base54.consider("if"),t.alternative&&base54.consider("else")):t instanceof AST_Var?base54.consider("var"):t instanceof AST_Const?base54.consider("const"):t instanceof AST_Lambda?base54.consider("function"):t instanceof AST_For?base54.consider("for"):t instanceof AST_ForIn?base54.consider("for in"):t instanceof AST_Switch?base54.consider("switch"):t instanceof AST_Case?base54.consider("case"):t instanceof AST_Default?base54.consider("default"):t instanceof AST_With?base54.consider("with"):t instanceof AST_ObjectSetter?base54.consider("set"+t.key):t instanceof AST_ObjectGetter?base54.consider("get"+t.key):t instanceof AST_ObjectKeyVal?base54.consider(t.key):t instanceof AST_New?base54.consider("new"):t instanceof AST_This?base54.consider("this"):t instanceof AST_Try?base54.consider("try"):t instanceof AST_Catch?base54.consider("catch"):t instanceof AST_Finally?base54.consider("finally"):t instanceof AST_Symbol&&t.unmangleable(e)?base54.consider(t.name):t instanceof AST_Unary||t instanceof AST_Binary?base54.consider(t.operator):t instanceof AST_Dot&&base54.consider(t.property)});this.walk(t),base54.sort()});var base54=function(){function n(){r=Object.create(null),t=e.split("").map(function(e){return e.charCodeAt(0)}),t.forEach(function(e){r[e]=0})}function i(e){var r="",n=54;e++;do e--,r+=String.fromCharCode(t[e%n]),e=Math.floor(e/n),n=64;while(e>0);return r}var t,r,e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_0123456789";return i.consider=function(e){for(var t=e.length;--t>=0;){var n=e.charCodeAt(t);n in r&&++r[n]}},i.sort=function(){t=mergeSort(t,function(e,t){return is_digit(e)&&!is_digit(t)?1:is_digit(t)&&!is_digit(e)?-1:r[t]-r[e]})},i.reset=n,n(),i.get=function(){return t},i.freq=function(){return r},i}();AST_Toplevel.DEFMETHOD("scope_warnings",function(e){e=defaults(e,{assign_to_global:!0,eval:!0,func_arguments:!0,nested_defuns:!0,undeclared:!1,unreferenced:!0});var t=new TreeWalker(function(r){if(e.undeclared&&r instanceof AST_SymbolRef&&r.undeclared()&&AST_Node.warn("Undeclared symbol: {name} [{file}:{line},{col}]",{name:r.name,file:r.start.file,line:r.start.line,col:r.start.col}),e.assign_to_global){var n=null;r instanceof AST_Assign&&r.left instanceof AST_SymbolRef?n=r.left:r instanceof AST_ForIn&&r.init instanceof AST_SymbolRef&&(n=r.init),n&&(n.undeclared()||n.global()&&n.scope!==n.definition().scope)&&AST_Node.warn("{msg}: {name} [{file}:{line},{col}]",{msg:n.undeclared()?"Accidental global?":"Assignment to global",name:n.name,file:n.start.file,line:n.start.line,col:n.start.col})}e.eval&&r instanceof AST_SymbolRef&&r.undeclared()&&"eval"==r.name&&AST_Node.warn("Eval is used [{file}:{line},{col}]",r.start),e.unreferenced&&(r instanceof AST_SymbolDeclaration||r instanceof AST_Label)&&!(r instanceof AST_SymbolCatch)&&r.unreferenced()&&AST_Node.warn("{type} {name} is declared but not referenced [{file}:{line},{col}]",{type:r instanceof AST_Label?"Label":"Symbol",name:r.name,file:r.start.file,line:r.start.line,col:r.start.col}),e.func_arguments&&r instanceof AST_Lambda&&r.uses_arguments&&AST_Node.warn("arguments used in function {name} [{file}:{line},{col}]",{name:r.name?r.name.name:"anonymous",file:r.start.file,line:r.start.line,col:r.start.col}),e.nested_defuns&&r instanceof AST_Defun&&!(t.parent()instanceof AST_Scope)&&AST_Node.warn('Function {name} declared in nested statement "{type}" [{file}:{line},{col}]',{name:r.name.name,type:t.parent().TYPE,file:r.start.file,line:r.start.line,col:r.start.col})});this.walk(t)});