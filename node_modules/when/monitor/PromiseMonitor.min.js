!function(e){"use strict";e(function(e){function o(e){this.logDelay=0,this.stackFilter=r,this.stackJumpSeparator=t,this.filterDuplicateFrames=!0,this._reporter=e,"function"==typeof e.configurePromiseMonitor&&e.configurePromiseMonitor(this),this._traces=[],this._traceTask=0;var n=this;this._doLogTraces=function(){n._logTraces()}}function s(e,t,r){t.length>1&&(t[0]=r,e.push.apply(e,t))}function u(e,t){return t.filter(function(t){return!e.test(t)})}function l(e){return!e.handler.handled}var t="from execution context:",r=/[\s\(\/\\](node|module|timers)\.js:|when([\/\\]{1,2}(lib|monitor|es6-shim)[\/\\]{1,2}|\.js)|(new\sPromise)\b|(\b(PromiseMonitor|ConsoleReporter|Scheduler|RunHandlerTask|ProgressTask|Promise|.*Handler)\.[\w_]\w\w+\b)|\b(tryCatch\w+|getHandler\w*)\b/i,n=e("../lib/env").setTimer,i=e("./error"),a=[];return o.prototype.monitor=function(e){var t=this;return e.createContext=function(e,r){e.context=t.createContext(e,r)},e.enterContext=function(e){a.push(e.context)},e.exitContext=function(){a.pop()},e.onPotentiallyUnhandledRejection=function(e,r){return t.addTrace(e,r)},e.onPotentiallyUnhandledRejectionHandled=function(e){return t.removeTrace(e)},e.onFatalRejection=function(e,r){return t.fatal(e,r)},this},o.prototype.createContext=function(e,t){var r={parent:t||a[a.length-1],stack:void 0};return i.captureStack(r,e.constructor),r},o.prototype.addTrace=function(e,t){var r,n;for(n=this._traces.length-1;n>=0&&(r=this._traces[n],r.handler!==e);--n);n>=0?r.extraContext=t:this._traces.push({handler:e,extraContext:t}),this.logTraces()},o.prototype.removeTrace=function(){this.logTraces()},o.prototype.fatal=function(e,t){var r=new Error;r.stack=this._createLongTrace(e.value,e.context,t).join("\n"),n(function(){throw r},0)},o.prototype.logTraces=function(){this._traceTask||(this._traceTask=n(this._doLogTraces,this.logDelay))},o.prototype._logTraces=function(){this._traceTask=void 0,this._traces=this._traces.filter(l),this._reporter.log(this.formatTraces(this._traces))},o.prototype.formatTraces=function(e){return e.map(function(e){return this._createLongTrace(e.handler.value,e.handler.context,e.extraContext)},this)},o.prototype._createLongTrace=function(e,t,r){var n=i.parse(e)||[String(e)+" (WARNING: non-Error used)"];return n=u(this.stackFilter,n,0),this._appendContext(n,t),this._appendContext(n,r),this.filterDuplicateFrames?this._removeDuplicates(n):n},o.prototype._removeDuplicates=function(e){var t={},r=this.stackJumpSeparator,n=0;return e.reduceRight(function(e,i,a){return 0===a?e.unshift(i):i===r?n>0&&(e.unshift(i),n=0):t[i]||(t[i]=!0,e.unshift(i),++n),e},[])},o.prototype._appendContext=function(e,t){e.push.apply(e,this._createTrace(t))},o.prototype._createTrace=function(e){for(var r,t=[];e;)r=i.parse(e),r&&(r=u(this.stackFilter,r),s(t,r,this.stackJumpSeparator)),e=e.parent;return t},o})}("function"==typeof define&&define.amd?define:function(e){module.exports=e(require)});