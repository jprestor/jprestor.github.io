"use strict";var utils=require("./utils"),formats=require("./formats"),arrayPrefixGenerators={brackets:function(e){return e+"[]"},indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},toISO=Date.prototype.toISOString,defaults={delimiter:"&",encode:!0,encoder:utils.encode,encodeValuesOnly:!1,serializeDate:function(e){return toISO.call(e)},skipNulls:!1,strictNullHandling:!1},stringify=function i(e,t,r,n,a,o,s,u,l,c,f,p){var h=e;if("function"==typeof s)h=s(t,h);else if(h instanceof Date)h=c(h);else if(null===h){if(n)return o&&!p?o(t):t;h=""}if("string"==typeof h||"number"==typeof h||"boolean"==typeof h||utils.isBuffer(h)){if(o){var d=p?t:o(t);return[f(d)+"="+f(o(h))]}return[f(t)+"="+f(String(h))]}var m=[];if("undefined"==typeof h)return m;var v;if(Array.isArray(s))v=s;else{var g=Object.keys(h);v=u?g.sort(u):g}for(var y=0;y<v.length;++y){var b=v[y];a&&null===h[b]||(m=Array.isArray(h)?m.concat(i(h[b],r(t,b),r,n,a,o,s,u,l,c,f,p)):m.concat(i(h[b],t+(l?"."+b:"["+b+"]"),r,n,a,o,s,u,l,c,f,p)))}return m};module.exports=function(e,t){var r=e,n=t||{};if(null!==n.encoder&&void 0!==n.encoder&&"function"!=typeof n.encoder)throw new TypeError("Encoder has to be a function.");var i="undefined"==typeof n.delimiter?defaults.delimiter:n.delimiter,a="boolean"==typeof n.strictNullHandling?n.strictNullHandling:defaults.strictNullHandling,o="boolean"==typeof n.skipNulls?n.skipNulls:defaults.skipNulls,s="boolean"==typeof n.encode?n.encode:defaults.encode,u="function"==typeof n.encoder?n.encoder:defaults.encoder,l="function"==typeof n.sort?n.sort:null,c="undefined"==typeof n.allowDots?!1:n.allowDots,f="function"==typeof n.serializeDate?n.serializeDate:defaults.serializeDate,p="boolean"==typeof n.encodeValuesOnly?n.encodeValuesOnly:defaults.encodeValuesOnly;if("undefined"==typeof n.format)n.format=formats["default"];else if(!Object.prototype.hasOwnProperty.call(formats.formatters,n.format))throw new TypeError("Unknown format option provided.");var d,m,h=formats.formatters[n.format];"function"==typeof n.filter?(m=n.filter,r=m("",r)):Array.isArray(n.filter)&&(m=n.filter,d=m);var v=[];if("object"!=typeof r||null===r)return"";var g;g=n.arrayFormat in arrayPrefixGenerators?n.arrayFormat:"indices"in n?n.indices?"indices":"repeat":"indices";var y=arrayPrefixGenerators[g];d||(d=Object.keys(r)),l&&d.sort(l);for(var b=0;b<d.length;++b){var w=d[b];o&&null===r[w]||(v=v.concat(stringify(r[w],w,y,a,o,s?u:null,m,l,c,f,h,p)))}return v.join(i)};