"use strict";function parseDate(e){if(e){var t=e.split(DATE_DELIM);if(t){for(var r=null,n=null,i=null,a=null,o=null,s=null,u=0;u<t.length;u++){var l=t[u].trim();if(l.length){var c;if(null===i&&(c=TIME.exec(l))){if(r=parseInt(c[1],10),n=parseInt(c[2],10),i=parseInt(c[3],10),r>23||n>59||i>59)return}else if(null===a&&(c=DAY_OF_MONTH.exec(l))){if(a=parseInt(c,10),1>a||a>31)return}else if(null===o&&(c=MONTH.exec(l)))o=MONTH_TO_NUM[c[1].toLowerCase()];else if(null===s&&(c=YEAR.exec(l),c&&(s=parseInt(c[0],10),s>=70&&99>=s?s+=1900:s>=0&&69>=s&&(s+=2e3),1601>s)))return}}if(null!==i&&null!==a&&null!==o&&null!==s)return new Date(Date.UTC(s,o,a,r,n,i))}}}function formatDate(e){var t=e.getUTCDate();t=t>=10?t:"0"+t;var r=e.getUTCHours();r=r>=10?r:"0"+r;var n=e.getUTCMinutes();n=n>=10?n:"0"+n;var i=e.getUTCSeconds();return i=i>=10?i:"0"+i,NUM_TO_DAY[e.getUTCDay()]+", "+t+" "+NUM_TO_MONTH[e.getUTCMonth()]+" "+e.getUTCFullYear()+" "+r+":"+n+":"+i+" GMT"}function canonicalDomain(e){return null==e?null:(e=e.trim().replace(/^\./,""),punycode&&/[^\u0001-\u007f]/.test(e)&&(e=punycode.toASCII(e)),e.toLowerCase())}function domainMatch(e,t,r){if(null==e||null==t)return null;if(r!==!1&&(e=canonicalDomain(e),t=canonicalDomain(t)),e==t)return!0;if(net.isIP(e))return!1;var n=e.indexOf(t);return 0>=n?!1:e.length!==t.length+n?!1:"."!==e.substr(n-1,1)?!1:!0}function defaultPath(e){if(!e||"/"!==e.substr(0,1))return"/";if("/"===e)return e;var t=e.lastIndexOf("/");return 0===t?"/":e.slice(0,t)}function parse(e,t){t&&"object"==typeof t||(t={}),e=e.trim();var r=e.indexOf(";"),n=t.loose?LOOSE_COOKIE_PAIR:COOKIE_PAIR,i=n.exec(-1===r?e:e.substr(0,r));if(i){var a=new Cookie;if(i[1]?a.key=i[2].trim():a.key="",a.value=i[3].trim(),!CONTROL_CHARS.test(a.key)&&!CONTROL_CHARS.test(a.value)){if(-1===r)return a;var o=e.slice(r+1).trim();if(0===o.length)return a;for(var s=o.split(";");s.length;){var u=s.shift().trim();if(0!==u.length){var c,f,l=u.indexOf("=");switch(-1===l?(c=u,f=null):(c=u.substr(0,l),f=u.substr(l+1)),c=c.trim().toLowerCase(),f&&(f=f.trim()),c){case"expires":if(f){var p=parseDate(f);p&&(a.expires=p)}break;case"max-age":if(f&&/^-?[0-9]+$/.test(f)){var h=parseInt(f,10);a.setMaxAge(h)}break;case"domain":if(f){var d=f.trim().replace(/^\./,"");d&&(a.domain=d.toLowerCase())}break;case"path":a.path=f&&"/"===f[0]?f:null;break;case"secure":a.secure=!0;break;case"httponly":a.httpOnly=!0;break;default:a.extensions=a.extensions||[],a.extensions.push(u)}}}return a}}}function jsonParse(e){var t;try{t=JSON.parse(e)}catch(r){return r}return t}function fromJSON(e){if(!e)return null;var t;if("string"==typeof e){if(t=jsonParse(e),t instanceof Error)return null}else t=e;for(var r=new Cookie,n=0;n<Cookie.serializableProperties.length;n++){var i=Cookie.serializableProperties[n];void 0!==t[i]&&t[i]!==Cookie.prototype[i]&&("expires"===i||"creation"===i||"lastAccessed"===i?null===t[i]?r[i]=null:r[i]="Infinity"==t[i]?"Infinity":new Date(t[i]):r[i]=t[i])}return r}function cookieCompare(e,t){var r=0,n=e.path?e.path.length:0,i=t.path?t.path.length:0;if(r=i-n,0!==r)return r;var a=e.creation?e.creation.getTime():MAX_TIME,o=t.creation?t.creation.getTime():MAX_TIME;return r=a-o,0!==r?r:r=e.creationIndex-t.creationIndex}function permutePath(e){if("/"===e)return["/"];e.lastIndexOf("/")===e.length-1&&(e=e.substr(0,e.length-1));for(var t=[e];e.length>1;){var r=e.lastIndexOf("/");if(0===r)break;e=e.substr(0,r),t.push(e)}return t.push("/"),t}function getCookieContext(e){if(e instanceof Object)return e;try{e=decodeURI(e)}catch(t){}return urlParse(e)}function Cookie(e){e=e||{},Object.keys(e).forEach(function(t){Cookie.prototype.hasOwnProperty(t)&&Cookie.prototype[t]!==e[t]&&"_"!==t.substr(0,1)&&(this[t]=e[t])},this),this.creation=this.creation||new Date,Object.defineProperty(this,"creationIndex",{configurable:!1,enumerable:!1,writable:!0,value:++Cookie.cookiesCreated})}function CookieJar(e,t){"boolean"==typeof t?t={rejectPublicSuffixes:t}:null==t&&(t={}),null!=t.rejectPublicSuffixes&&(this.rejectPublicSuffixes=t.rejectPublicSuffixes),null!=t.looseMode&&(this.enableLooseMode=t.looseMode),e||(e=new MemoryCookieStore),this.store=e}function syncWrap(e){return function(){if(!this.store.synchronous)throw new Error("CookieJar store is not synchronous; use async API instead.");var r,n,t=Array.prototype.slice.call(arguments);if(t.push(function(e,t){r=e,n=t}),this[e].apply(this,t),r)throw r;return n}}var net=require("net"),urlParse=require("url").parse,pubsuffix=require("./pubsuffix"),Store=require("./store").Store,MemoryCookieStore=require("./memstore").MemoryCookieStore,pathMatch=require("./pathMatch").pathMatch,VERSION=require("../package.json").version,punycode;try{punycode=require("punycode")}catch(e){console.warn("cookie: can't load punycode; won't use punycode for domain normalization")}var DATE_DELIM=/[\x09\x20-\x2F\x3B-\x40\x5B-\x60\x7B-\x7E]/,COOKIE_OCTET=/[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]/,COOKIE_OCTETS=new RegExp("^"+COOKIE_OCTET.source+"+$"),CONTROL_CHARS=/[\x00-\x1F]/,COOKIE_PAIR=/^(([^=;]+))\s*=\s*([^\n\r\0]*)/,LOOSE_COOKIE_PAIR=/^((?:=)?([^=;]*)\s*=\s*)?([^\n\r\0]*)/,PATH_VALUE=/[\x20-\x3A\x3C-\x7E]+/,DAY_OF_MONTH=/^(\d{1,2})[^\d]*$/,TIME=/^(\d{1,2})[^\d]*:(\d{1,2})[^\d]*:(\d{1,2})[^\d]*$/,MONTH=/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i,MONTH_TO_NUM={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11},NUM_TO_MONTH=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],NUM_TO_DAY=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],YEAR=/^(\d{2}|\d{4})$/,MAX_TIME=2147483647e3,MIN_TIME=0;Cookie.cookiesCreated=0,Cookie.parse=parse,Cookie.fromJSON=fromJSON,Cookie.prototype.key="",Cookie.prototype.value="",Cookie.prototype.expires="Infinity",Cookie.prototype.maxAge=null,Cookie.prototype.domain=null,Cookie.prototype.path=null,Cookie.prototype.secure=!1,Cookie.prototype.httpOnly=!1,Cookie.prototype.extensions=null,Cookie.prototype.hostOnly=null,Cookie.prototype.pathIsDefault=null,Cookie.prototype.creation=null,Cookie.prototype.lastAccessed=null,Object.defineProperty(Cookie.prototype,"creationIndex",{configurable:!0,enumerable:!1,writable:!0,value:0}),Cookie.serializableProperties=Object.keys(Cookie.prototype).filter(function(e){return!(Cookie.prototype[e]instanceof Function||"creationIndex"===e||"_"===e.substr(0,1))}),Cookie.prototype.inspect=function(){var e=Date.now();return'Cookie="'+this.toString()+"; hostOnly="+(null!=this.hostOnly?this.hostOnly:"?")+"; aAge="+(this.lastAccessed?e-this.lastAccessed.getTime()+"ms":"?")+"; cAge="+(this.creation?e-this.creation.getTime()+"ms":"?")+'"'},Cookie.prototype.toJSON=function(){for(var e={},t=Cookie.serializableProperties,r=0;r<t.length;r++){var n=t[r];this[n]!==Cookie.prototype[n]&&("expires"===n||"creation"===n||"lastAccessed"===n?null===this[n]?e[n]=null:e[n]="Infinity"==this[n]?"Infinity":this[n].toISOString():"maxAge"===n?null!==this[n]&&(e[n]=this[n]==1/0||this[n]==-(1/0)?this[n].toString():this[n]):this[n]!==Cookie.prototype[n]&&(e[n]=this[n]))}return e},Cookie.prototype.clone=function(){return fromJSON(this.toJSON())},Cookie.prototype.validate=function(){if(!COOKIE_OCTETS.test(this.value))return!1;if(!(this.expires==1/0||this.expires instanceof Date||parseDate(this.expires)))return!1;if(null!=this.maxAge&&this.maxAge<=0)return!1;if(null!=this.path&&!PATH_VALUE.test(this.path))return!1;var e=this.cdomain();if(e){if(e.match(/\.$/))return!1;var t=pubsuffix.getPublicSuffix(e);if(null==t)return!1}return!0},Cookie.prototype.setExpires=function(e){e instanceof Date?this.expires=e:this.expires=parseDate(e)||"Infinity"},Cookie.prototype.setMaxAge=function(e){e===1/0||e===-(1/0)?this.maxAge=e.toString():this.maxAge=e},Cookie.prototype.cookieString=function(){var e=this.value;return null==e&&(e=""),""===this.key?e:this.key+"="+e},Cookie.prototype.toString=function(){var e=this.cookieString();return this.expires!=1/0&&(e+=this.expires instanceof Date?"; Expires="+formatDate(this.expires):"; Expires="+this.expires),null!=this.maxAge&&this.maxAge!=1/0&&(e+="; Max-Age="+this.maxAge),this.domain&&!this.hostOnly&&(e+="; Domain="+this.domain),this.path&&(e+="; Path="+this.path),this.secure&&(e+="; Secure"),this.httpOnly&&(e+="; HttpOnly"),this.extensions&&this.extensions.forEach(function(t){e+="; "+t}),e},Cookie.prototype.TTL=function(e){if(null!=this.maxAge)return this.maxAge<=0?0:1e3*this.maxAge;var t=this.expires;return t!=1/0?(t instanceof Date||(t=parseDate(t)||1/0),t==1/0?1/0:t.getTime()-(e||Date.now())):1/0},Cookie.prototype.expiryTime=function(e){if(null!=this.maxAge){var t=e||this.creation||new Date,r=this.maxAge<=0?-(1/0):1e3*this.maxAge;return t.getTime()+r}return this.expires==1/0?1/0:this.expires.getTime()},Cookie.prototype.expiryDate=function(e){var t=this.expiryTime(e);return t==1/0?new Date(MAX_TIME):t==-(1/0)?new Date(MIN_TIME):new Date(t)},Cookie.prototype.isPersistent=function(){return null!=this.maxAge||this.expires!=1/0},Cookie.prototype.cdomain=Cookie.prototype.canonicalizedDomain=function(){return null==this.domain?null:canonicalDomain(this.domain)},CookieJar.prototype.store=null,CookieJar.prototype.rejectPublicSuffixes=!0,CookieJar.prototype.enableLooseMode=!1;var CAN_BE_SYNC=[];CAN_BE_SYNC.push("setCookie"),CookieJar.prototype.setCookie=function(e,t,r,n){function f(t,i){if(t)return n(t);var a=function(t){return t?n(t):void n(null,e)};if(i){if(r.http===!1&&i.httpOnly)return t=new Error("old Cookie is HttpOnly and this isn't an HTTP API"),n(r.ignoreError?null:t);e.creation=i.creation,e.creationIndex=i.creationIndex,e.lastAccessed=u,c.updateCookie(i,e,a)}else e.creation=e.lastAccessed=u,c.putCookie(e,a)}var i,a=getCookieContext(t);r instanceof Function&&(n=r,r={});var o=canonicalDomain(a.hostname),s=this.enableLooseMode;if(null!=r.loose&&(s=r.loose),e instanceof Cookie||(e=Cookie.parse(e,{loose:s})),!e)return i=new Error("Cookie failed to parse"),n(r.ignoreError?null:i);var u=r.now||new Date;if(this.rejectPublicSuffixes&&e.domain){var l=pubsuffix.getPublicSuffix(e.cdomain());if(null==l)return i=new Error("Cookie has domain set to a public suffix"),n(r.ignoreError?null:i)}if(e.domain){if(!domainMatch(o,e.cdomain(),!1))return i=new Error("Cookie not in this host's domain. Cookie:"+e.cdomain()+" Request:"+o),n(r.ignoreError?null:i);null==e.hostOnly&&(e.hostOnly=!1)}else e.hostOnly=!0,e.domain=o;if(e.path&&"/"===e.path[0]||(e.path=defaultPath(a.pathname),e.pathIsDefault=!0),r.http===!1&&e.httpOnly)return i=new Error("Cookie is HttpOnly and this isn't an HTTP API"),n(r.ignoreError?null:i);var c=this.store;c.updateCookie||(c.updateCookie=function(e,t,r){this.putCookie(t,r)}),c.findCookie(e.domain,e.path,e.key,f)},CAN_BE_SYNC.push("getCookies"),CookieJar.prototype.getCookies=function(e,t,r){function p(e){if(e.hostOnly){if(e.domain!=i)return!1}else if(!domainMatch(i,e.domain,!1))return!1;return c||pathMatch(a,e.path)?e.secure&&!o?!1:e.httpOnly&&!s?!1:l&&e.expiryTime()<=u?(f.removeCookie(e.domain,e.path,e.key,function(){}),!1):!0:!1}var n=getCookieContext(e);t instanceof Function&&(r=t,t={});var i=canonicalDomain(n.hostname),a=n.pathname||"/",o=t.secure;null!=o||!n.protocol||"https:"!=n.protocol&&"wss:"!=n.protocol||(o=!0);var s=t.http;null==s&&(s=!0);var u=t.now||Date.now(),l=t.expire!==!1,c=!!t.allPaths,f=this.store;f.findCookies(i,c?null:a,function(e,n){if(e)return r(e);n=n.filter(p),t.sort!==!1&&(n=n.sort(cookieCompare));var i=new Date;n.forEach(function(e){e.lastAccessed=i}),r(null,n)})},CAN_BE_SYNC.push("getCookieString"),CookieJar.prototype.getCookieString=function(){var e=Array.prototype.slice.call(arguments,0),t=e.pop(),r=function(e,r){e?t(e):t(null,r.sort(cookieCompare).map(function(e){return e.cookieString()}).join("; "))};e.push(r),this.getCookies.apply(this,e)},CAN_BE_SYNC.push("getSetCookieStrings"),CookieJar.prototype.getSetCookieStrings=function(){var e=Array.prototype.slice.call(arguments,0),t=e.pop(),r=function(e,r){e?t(e):t(null,r.map(function(e){return e.toString()}))};e.push(r),this.getCookies.apply(this,e)},CAN_BE_SYNC.push("serialize"),CookieJar.prototype.serialize=function(e){var t=this.store.constructor.name;"Object"===t&&(t=null);var r={version:"tough-cookie@"+VERSION,storeType:t,rejectPublicSuffixes:!!this.rejectPublicSuffixes,cookies:[]};return this.store.getAllCookies&&"function"==typeof this.store.getAllCookies?void this.store.getAllCookies(function(t,n){return t?e(t):(r.cookies=n.map(function(e){return e=e instanceof Cookie?e.toJSON():e,delete e.creationIndex,e}),e(null,r))}):e(new Error("store does not support getAllCookies and cannot be serialized"))},CookieJar.prototype.toJSON=function(){return this.serializeSync()},CAN_BE_SYNC.push("_importCookies"),CookieJar.prototype._importCookies=function(e,t){function i(e){if(e)return t(e);if(!n.length)return t(e,r);var a;try{a=fromJSON(n.shift())}catch(o){return t(o)}return null===a?i(null):void r.store.putCookie(a,i)}var r=this,n=e.cookies;return n&&Array.isArray(n)?void i():t(new Error("serialized jar has no cookies array"))},CookieJar.deserialize=function(e,t,r){3!==arguments.length&&(r=t,t=null);var n;if("string"==typeof e){if(n=jsonParse(e),n instanceof Error)return r(n)}else n=e;var i=new CookieJar(t,n.rejectPublicSuffixes);i._importCookies(n,function(e){return e?r(e):void r(null,i)})},CookieJar.deserializeSync=function(e,t){var r="string"==typeof e?JSON.parse(e):e,n=new CookieJar(t,r.rejectPublicSuffixes);if(!n.store.synchronous)throw new Error("CookieJar store is not synchronous; use async API instead.");return n._importCookiesSync(r),n},CookieJar.fromJSON=CookieJar.deserializeSync,CAN_BE_SYNC.push("clone"),CookieJar.prototype.clone=function(e,t){1===arguments.length&&(t=e,e=null),this.serialize(function(r,n){return r?t(r):void CookieJar.deserialize(e,n,t)})},CAN_BE_SYNC.forEach(function(e){CookieJar.prototype[e+"Sync"]=syncWrap(e)}),module.exports={CookieJar:CookieJar,Cookie:Cookie,Store:Store,MemoryCookieStore:MemoryCookieStore,parseDate:parseDate,formatDate:formatDate,parse:parse,fromJSON:fromJSON,domainMatch:domainMatch,defaultPath:defaultPath,pathMatch:pathMatch,getPublicSuffix:pubsuffix.getPublicSuffix,cookieCompare:cookieCompare,permuteDomain:require("./permuteDomain").permuteDomain,permutePath:permutePath,canonicalDomain:canonicalDomain};