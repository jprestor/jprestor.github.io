var Dgram=require("dgram"),Dns=require("dns"),Hoek=require("hoek"),internals={};exports.time=function(e,t){2!==arguments.length&&(t=arguments[0],e={});var r=Hoek.clone(e);r.host=r.host||"pool.ntp.org",r.port=r.port||123,r.resolveReference=r.resolveReference||!1;var n=0,i=0,a=function(e,r){return n&&(clearTimeout(n),n=0),o.removeAllListeners(),o.once("error",internals.ignore),o.close(),t(e,r)};a=Hoek.once(a);var o=Dgram.createSocket("udp4");o.once("error",function(e){return a(e)}),o.on("message",function(e,t){var n=Date.now(),o=new internals.NtpMessage(e);if(!o.isValid)return a(new Error("Invalid server response"),o);if(o.originateTimestamp!==i)return a(new Error("Wrong originate timestamp"),o);var s=o.originateTimestamp,u=o.receiveTimestamp,l=o.transmitTimestamp,c=n;return o.d=c-s-(l-u),o.t=(u-s+(l-c))/2,o.receivedLocally=n,r.resolveReference&&"secondary"===o.stratum?void Dns.reverse(o.referenceId,function(e,t){return e||(o.referenceHost=t[0]),a(null,o)}):a(null,o)}),r.timeout&&(n=setTimeout(function(){return n=0,a(new Error("Timeout"))},r.timeout));for(var s=new Buffer(48),u=0;48>u;u++)s[u]=0;s[0]=35,i=Date.now(),internals.fromMsecs(i,s,40),o.send(s,0,s.length,r.port,r.host,function(e,t){return e||48!==t?a(e||new Error("Could not send entire message")):void 0})},internals.NtpMessage=function(e){if(this.isValid=!1,48===e.length){var t=e[0]>>6;switch(t){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}var r=(56&e[0])>>3;this.version=r;var n=7&e[0];switch(n){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var i=e[1];0===i?this.stratum="death":1===i?this.stratum="primary":15>=i?this.stratum="secondary":this.stratum="reserved",this.pollInterval=1e3*Math.round(Math.pow(2,e[2])),this.precision=1e3*Math.pow(2,e[3]);var a=256*(256*(256*e[4]+e[5])+e[6])+e[7];switch(this.rootDelay=1e3*(a/65536),this.rootDispersion=1e3*((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16)),this.referenceId="",this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=internals.toMsecs(e,16),this.originateTimestamp=internals.toMsecs(e,24),this.receiveTimestamp=internals.toMsecs(e,32),this.transmitTimestamp=internals.toMsecs(e,40),4===this.version&&"reserved"!==this.stratum&&"server"===this.mode&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this}},internals.toMsecs=function(e,t){for(var r=0,n=0,i=0;4>i;++i)r=256*r+e[t+i];for(i=4;8>i;++i)n=256*n+e[t+i];return 1e3*(r-2208988800+n/Math.pow(2,32))},internals.fromMsecs=function(e,t,r){var n=Math.floor(e/1e3)+2208988800,i=Math.round(e%1e3/1e3*Math.pow(2,32));t[r+0]=(4278190080&n)>>24,t[r+1]=(16711680&n)>>16,t[r+2]=(65280&n)>>8,t[r+3]=255&n,t[r+4]=(4278190080&i)>>24,t[r+5]=(16711680&i)>>16,t[r+6]=(65280&i)>>8,t[r+7]=255&i},internals.last={offset:0,expires:0,host:"",port:0},exports.offset=function(e,t){2!==arguments.length&&(t=arguments[0],e={});var r=Date.now(),n=e.clockSyncRefresh||864e5;return internals.last.offset&&internals.last.host===e.host&&internals.last.port===e.port&&r<internals.last.expires?void process.nextTick(function(){t(null,internals.last.offset)}):void exports.time(e,function(i,a){return i?t(i,0):(internals.last={offset:Math.round(a.t),expires:r+n,host:e.host,port:e.port},t(null,internals.last.offset))})},internals.now={intervalId:0},exports.start=function(e,t){return 2!==arguments.length&&(t=arguments[0],e={}),internals.now.intervalId?void process.nextTick(function(){t()}):void exports.offset(e,function(r,n){return internals.now.intervalId=setInterval(function(){exports.offset(e,function(){})},e.clockSyncRefresh||864e5),t()})},exports.stop=function(){internals.now.intervalId&&(clearInterval(internals.now.intervalId),internals.now.intervalId=0)},exports.isLive=function(){return!!internals.now.intervalId},exports.now=function(){var e=Date.now();return!exports.isLive()||e>=internals.last.expires?e:e+internals.last.offset},internals.ignore=function(){};