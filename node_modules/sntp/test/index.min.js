var Dns=require("dns"),Dgram=require("dgram"),Lab=require("lab"),Sntp=require("../lib"),internals={},lab=exports.lab=Lab.script(),before=lab.before,after=lab.after,describe=lab.experiment,it=lab.test,expect=Lab.expect;describe("SNTP",function(){describe("#time",function(){it("returns consistent result over multiple tries",function(e){Sntp.time(function(t,r){expect(t).to.not.exist,expect(r).to.exist;var n=r.t;Sntp.time(function(t,r){expect(t).to.not.exist,expect(r).to.exist;var i=r.t;expect(Math.abs(n-i)).is.below(200),e()})})}),it("resolves reference IP",function(e){Sntp.time({host:"ntp.exnet.com",resolveReference:!0},function(t,r){expect(t).to.not.exist,expect(r).to.exist,expect(r.referenceHost).to.exist,e()})}),it("times out on no response",function(e){Sntp.time({port:124,timeout:100},function(t,r){expect(t).to.exist,expect(r).to.not.exist,expect(t.message).to.equal("Timeout"),e()})}),it("errors on error event",{parallel:!1},function(e){var t=Dgram.createSocket;Dgram.createSocket=function(e){Dgram.createSocket=t;var r=Dgram.createSocket(e);return setImmediate(function(){r.emit("error",new Error("Fake"))}),r},Sntp.time(function(t,r){expect(t).to.exist,expect(r).to.not.exist,expect(t.message).to.equal("Fake"),e()})}),it("errors on incorrect sent size",{parallel:!1},function(e){var t=Dgram.Socket.prototype.send;Dgram.Socket.prototype.send=function(e,r,n,i,a,o){return Dgram.Socket.prototype.send=t,o(null,40)},Sntp.time(function(t,r){expect(t).to.exist,expect(r).to.not.exist,expect(t.message).to.equal("Could not send entire message"),e()})}),it("times out on invalid host",function(e){Sntp.time({host:"error",timeout:1e4},function(t,r){expect(t).to.exist,expect(r).to.not.exist,expect(t.message).to.contain("getaddrinfo"),e()})}),it("fails on bad response buffer size",function(e){var t=Dgram.createSocket("udp4");t.on("message",function(e,r){var e=new Buffer(10);t.send(e,0,e.length,r.port,r.address,function(e,r){t.close()})}),t.bind(49123),Sntp.time({host:"localhost",port:49123},function(t,r){expect(t).to.exist,expect(t.message).to.equal("Invalid server response"),e()})});var e=function(e){var t=Dgram.createSocket("udp4");t.on("message",function(r,n){for(var r=new Buffer([36,1,0,227,0,0,0,0,0,0,0,0,65,67,84,83,212,168,45,199,28,93,73,27,212,168,45,230,103,239,157,178,212,168,45,230,113,237,181,251,212,168,45,230,113,238,108,197]),i=0,a=e.length;a>i;++i)r[e[i][0]]=e[i][1];t.send(r,0,r.length,n.port,n.address,function(e,r){t.close()})}),t.bind(49123)};it("fails on bad version",function(t){e([[0,28]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.version).to.equal(3),expect(e.message).to.equal("Invalid server response"),t()})}),it("fails on bad originateTimestamp",function(t){e([[24,131],[25,170],[26,126],[27,128],[28,0],[29,0],[30,0],[31,0]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(e.message).to.equal("Invalid server response"),t()})}),it("fails on bad receiveTimestamp",function(t){e([[32,131],[33,170],[34,126],[35,128],[36,0],[37,0],[38,0],[39,0]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(e.message).to.equal("Invalid server response"),t()})}),it("fails on bad originate timestamp and alarm li",function(t){e([[0,228]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(e.message).to.equal("Wrong originate timestamp"),expect(r.leapIndicator).to.equal("alarm"),t()})}),it("returns time with death stratum and last61 li",function(t){e([[0,100],[1,0]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(r.stratum).to.equal("death"),expect(r.leapIndicator).to.equal("last-minute-61"),t()})}),it("returns time with reserved stratum and last59 li",function(t){e([[0,164],[1,31]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(r.stratum).to.equal("reserved"),expect(r.leapIndicator).to.equal("last-minute-59"),t()})}),it("fails on bad mode (symmetric-active)",function(t){e([[0,33]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.mode).to.equal("symmetric-active"),t()})}),it("fails on bad mode (symmetric-passive)",function(t){e([[0,34]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.mode).to.equal("symmetric-passive"),t()})}),it("fails on bad mode (client)",function(t){e([[0,35]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.mode).to.equal("client"),t()})}),it("fails on bad mode (broadcast)",function(t){e([[0,37]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.mode).to.equal("broadcast"),t()})}),it("fails on bad mode (reserved)",function(t){e([[0,38]]),Sntp.time({host:"localhost",port:49123},function(e,r){expect(e).to.exist,expect(r.mode).to.equal("reserved"),t()})})}),describe("#offset",function(){it("gets the current offset",function(e){Sntp.offset(function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(0),e()})}),it("gets the current offset from cache",function(e){Sntp.offset(function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(0);var n=r;Sntp.offset({},function(t,r){expect(t).to.not.exist,expect(r).to.equal(n),e()})})}),it("gets the new offset on different server",function(e){Sntp.offset(function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(0);var n=r;Sntp.offset({host:"nist1-sj.ustiming.org"},function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(n),e()})})}),it("gets the new offset on different server",function(e){Sntp.offset(function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(0);var n=r;Sntp.offset({port:123},function(t,r){expect(t).to.not.exist,expect(r).to.not.equal(n),e()})})}),it("fails getting the current offset on invalid server",function(e){Sntp.offset({host:"error"},function(t,r){expect(t).to.exist,expect(r).to.equal(0),e()})})}),describe("#now",function(){it("starts auto-sync, gets now, then stops",function(e){Sntp.stop();var t=Sntp.now();expect(t).to.equal(Date.now()),Sntp.start(function(){var t=Sntp.now();expect(t).to.not.equal(Date.now()),Sntp.stop(),e()})}),it("starts twice",function(e){Sntp.start(function(){Sntp.start(function(){var t=Sntp.now();expect(t).to.not.equal(Date.now()),Sntp.stop(),e()})})}),it("starts auto-sync, gets now, waits, gets again after timeout",function(e){Sntp.stop();var t=Sntp.now();expect(t).to.equal(Date.now()),Sntp.start({clockSyncRefresh:100},function(){var t=Sntp.now();expect(t).to.not.equal(Date.now()),expect(t).to.equal(Sntp.now()),setTimeout(function(){expect(Sntp.now()).to.not.equal(t),Sntp.stop(),e()},110)})})})});