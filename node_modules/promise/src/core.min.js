"use strict";function noop(){}function getThen(e){try{return e.then}catch(t){return LAST_ERROR=t,IS_ERROR}}function tryCallOne(e,t){try{return e(t)}catch(r){return LAST_ERROR=r,IS_ERROR}}function tryCallTwo(e,t,r){try{e(t,r)}catch(n){return LAST_ERROR=n,IS_ERROR}}function Promise(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("Promise constructor's argument is not a function");this._deferredState=0,this._state=0,this._value=null,this._deferreds=null,e!==noop&&doResolve(e,this)}function safeThen(e,t,r){return new e.constructor(function(n,i){var a=new Promise(noop);a.then(n,i),handle(e,new Handler(t,r,a))})}function handle(e,t){for(;3===e._state;)e=e._value;return Promise._onHandle&&Promise._onHandle(e),0===e._state?0===e._deferredState?(e._deferredState=1,void(e._deferreds=t)):1===e._deferredState?(e._deferredState=2,void(e._deferreds=[e._deferreds,t])):void e._deferreds.push(t):void handleResolved(e,t)}function handleResolved(e,t){asap(function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null===r)return void(1===e._state?resolve(t.promise,e._value):reject(t.promise,e._value));var n=tryCallOne(r,e._value);n===IS_ERROR?reject(t.promise,LAST_ERROR):resolve(t.promise,n)})}function resolve(e,t){if(t===e)return reject(e,new TypeError("A promise cannot be resolved with itself."));if(t&&("object"==typeof t||"function"==typeof t)){var r=getThen(t);if(r===IS_ERROR)return reject(e,LAST_ERROR);if(r===e.then&&t instanceof Promise)return e._state=3,e._value=t,void finale(e);if("function"==typeof r)return void doResolve(r.bind(t),e)}e._state=1,e._value=t,finale(e)}function reject(e,t){e._state=2,e._value=t,Promise._onReject&&Promise._onReject(e,t),finale(e)}function finale(e){if(1===e._deferredState&&(handle(e,e._deferreds),e._deferreds=null),2===e._deferredState){for(var t=0;t<e._deferreds.length;t++)handle(e,e._deferreds[t]);e._deferreds=null}}function Handler(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function doResolve(e,t){var r=!1,n=tryCallTwo(e,function(e){r||(r=!0,resolve(t,e))},function(e){r||(r=!0,reject(t,e))});r||n!==IS_ERROR||(r=!0,reject(t,LAST_ERROR))}var asap=require("asap/raw"),LAST_ERROR=null,IS_ERROR={};module.exports=Promise,Promise._onHandle=null,Promise._onReject=null,Promise._noop=noop,Promise.prototype.then=function(e,t){if(this.constructor!==Promise)return safeThen(this,e,t);var r=new Promise(noop);return handle(this,new Handler(e,t,r)),r};