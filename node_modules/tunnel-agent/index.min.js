"use strict";function httpOverHttp(e){var t=new TunnelingAgent(e);return t.request=http.request,t}function httpsOverHttp(e){var t=new TunnelingAgent(e);return t.request=http.request,t.createSocket=createSecureSocket,t.defaultPort=443,t}function httpOverHttps(e){var t=new TunnelingAgent(e);return t.request=https.request,t}function httpsOverHttps(e){var t=new TunnelingAgent(e);return t.request=https.request,t.createSocket=createSecureSocket,t.defaultPort=443,t}function TunnelingAgent(e){var t=this;t.options=e||{},t.proxyOptions=t.options.proxy||{},t.maxSockets=t.options.maxSockets||http.Agent.defaultMaxSockets,t.requests=[],t.sockets=[],t.on("free",function(e,r,n){for(var i=0,a=t.requests.length;a>i;++i){var o=t.requests[i];if(o.host===r&&o.port===n)return t.requests.splice(i,1),void o.request.onSocket(e)}e.destroy(),t.removeSocket(e)})}function createSecureSocket(e,t){var r=this;TunnelingAgent.prototype.createSocket.call(r,e,function(n){var i=tls.connect(0,mergeOptions({},r.options,{servername:e.host,socket:n}));r.sockets[r.sockets.indexOf(n)]=i,t(i)})}function mergeOptions(e){for(var t=1,r=arguments.length;r>t;++t){var n=arguments[t];if("object"==typeof n)for(var i=Object.keys(n),a=0,o=i.length;o>a;++a){var s=i[a];void 0!==n[s]&&(e[s]=n[s])}}return e}var net=require("net"),tls=require("tls"),http=require("http"),https=require("https"),events=require("events"),assert=require("assert"),util=require("util"),Buffer=require("safe-buffer").Buffer;exports.httpOverHttp=httpOverHttp,exports.httpsOverHttp=httpsOverHttp,exports.httpOverHttps=httpOverHttps,exports.httpsOverHttps=httpsOverHttps,util.inherits(TunnelingAgent,events.EventEmitter),TunnelingAgent.prototype.addRequest=function(e,t){var r=this;return"string"==typeof t&&(t={host:t,port:arguments[2],path:arguments[3]}),r.sockets.length>=this.maxSockets?void r.requests.push({host:t.host,port:t.port,request:e}):void r.createConnection({host:t.host,port:t.port,request:e})},TunnelingAgent.prototype.createConnection=function(e){var t=this;t.createSocket(e,function(r){function n(){t.emit("free",r,e.host,e.port)}function i(e){t.removeSocket(r),r.removeListener("free",n),r.removeListener("close",i),r.removeListener("agentRemove",i)}r.on("free",n),r.on("close",i),r.on("agentRemove",i),e.request.onSocket(r)})},TunnelingAgent.prototype.createSocket=function(e,t){function o(e){e.upgrade=!0}function s(e,t,r){process.nextTick(function(){u(e,t,r)})}function u(i,o,s){if(a.removeAllListeners(),o.removeAllListeners(),200===i.statusCode)assert.equal(s.length,0),debug("tunneling connection has established"),r.sockets[r.sockets.indexOf(n)]=o,t(o);else{debug("tunneling socket could not be established, statusCode=%d",i.statusCode);var u=new Error("tunneling socket could not be established, statusCode="+i.statusCode);u.code="ECONNRESET",e.request.emit("error",u),r.removeSocket(n)}}function l(t){a.removeAllListeners(),debug("tunneling socket could not be established, cause=%s\n",t.message,t.stack);var i=new Error("tunneling socket could not be established, cause="+t.message);i.code="ECONNRESET",e.request.emit("error",i),r.removeSocket(n)}var r=this,n={};r.sockets.push(n);var i=mergeOptions({},r.proxyOptions,{method:"CONNECT",path:e.host+":"+e.port,agent:!1});i.proxyAuth&&(i.headers=i.headers||{},i.headers["Proxy-Authorization"]="Basic "+Buffer.from(i.proxyAuth).toString("base64")),debug("making CONNECT request");var a=r.request(i);a.useChunkedEncodingByDefault=!1,a.once("response",o),a.once("upgrade",s),a.once("connect",u),a.once("error",l),a.end()},TunnelingAgent.prototype.removeSocket=function(e){var t=this.sockets.indexOf(e);if(-1!==t){this.sockets.splice(t,1);var r=this.requests.shift();r&&this.createConnection(r)}};var debug;debug=process.env.NODE_DEBUG&&/\btunnel\b/.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]?e[0]="TUNNEL: "+e[0]:e.unshift("TUNNEL:"),console.error.apply(console,e)}:function(){},exports.debug=debug;