"use strict";function OAuth(e){this.request=e,this.params=null}var url=require("url"),qs=require("qs"),caseless=require("caseless"),uuid=require("uuid"),oauth=require("oauth-sign"),crypto=require("crypto"),Buffer=require("safe-buffer").Buffer;OAuth.prototype.buildParams=function(e,t,r,n,i,a){var o={};for(var s in e)o["oauth_"+s]=e[s];o.oauth_version||(o.oauth_version="1.0"),o.oauth_timestamp||(o.oauth_timestamp=Math.floor(Date.now()/1e3).toString()),o.oauth_nonce||(o.oauth_nonce=uuid().replace(/-/g,"")),o.oauth_signature_method||(o.oauth_signature_method="HMAC-SHA1");var u=o.oauth_consumer_secret||o.oauth_private_key;delete o.oauth_consumer_secret,delete o.oauth_private_key;var l=o.oauth_token_secret;delete o.oauth_token_secret;var c=o.oauth_realm;delete o.oauth_realm,delete o.oauth_transport_method;var f=t.protocol+"//"+t.host+t.pathname,p=a.parse([].concat(n,i,a.stringify(o)).join("&"));return o.oauth_signature=oauth.sign(o.oauth_signature_method,r,f,p,u,l),c&&(o.realm=c),o},OAuth.prototype.buildBodyHash=function(e,t){["HMAC-SHA1","RSA-SHA1"].indexOf(e.signature_method||"HMAC-SHA1")<0&&this.request.emit("error",new Error("oauth: "+e.signature_method+" signature_method not supported with body_hash signing."));var r=crypto.createHash("sha1");r.update(t||"");var n=r.digest("hex");return Buffer.from(n).toString("base64")},OAuth.prototype.concatParams=function(e,t,r){r=r||"";var n=Object.keys(e).filter(function(e){return"realm"!==e&&"oauth_signature"!==e}).sort();return e.realm&&n.splice(0,0,"realm"),n.push("oauth_signature"),n.map(function(t){return t+"="+r+oauth.rfc3986(e[t])+r}).join(t)},OAuth.prototype.onRequest=function(e){var t=this;t.params=e;var s,u,r=t.request.uri||{},n=t.request.method||"",i=caseless(t.request.headers),a=t.request.body||"",o=t.request.qsLib||qs,l=i.get("content-type")||"",c="application/x-www-form-urlencoded",f=e.transport_method||"header";l.slice(0,c.length)===c&&(l=c,s=a),r.query&&(u=r.query),"body"!==f||"POST"===n&&l===c||t.request.emit("error",new Error("oauth: transport_method of body requires POST and content-type "+c)),s||"boolean"!=typeof e.body_hash||(e.body_hash=t.buildBodyHash(e,t.request.body.toString()));var p=t.buildParams(e,r,n,u,s,o);switch(f){case"header":t.request.setHeader("Authorization","OAuth "+t.concatParams(p,",",'"'));break;case"query":var h=t.request.uri.href+=(u?"&":"?")+t.concatParams(p,"&");t.request.uri=url.parse(h),t.request.path=t.request.uri.path;break;case"body":t.request.body=(s?s+"&":"")+t.concatParams(p,"&");break;default:t.request.emit("error",new Error("oauth: transport_method invalid"))}},exports.OAuth=OAuth;