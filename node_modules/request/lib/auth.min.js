"use strict";function Auth(e){this.request=e,this.hasAuth=!1,this.sentAuth=!1,this.bearerToken=null,this.user=null,this.pass=null}var caseless=require("caseless"),uuid=require("uuid"),helpers=require("./helpers"),md5=helpers.md5,toBase64=helpers.toBase64;Auth.prototype.basic=function(e,t,r){var n=this;("string"!=typeof e||void 0!==t&&"string"!=typeof t)&&n.request.emit("error",new Error("auth() received invalid user or password")),n.user=e,n.pass=t,n.hasAuth=!0;var i=e+":"+(t||"");if(r||"undefined"==typeof r){var a="Basic "+toBase64(i);return n.sentAuth=!0,a}},Auth.prototype.bearer=function(e,t){var r=this;if(r.bearerToken=e,r.hasAuth=!0,t||"undefined"==typeof t){"function"==typeof e&&(e=e());var n="Bearer "+(e||"");return r.sentAuth=!0,n}},Auth.prototype.digest=function(e,t,r){for(var n=this,i={},a=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;;){var o=a.exec(r);if(!o)break;i[o[1]]=o[2]||o[3]}var s=function(e,t,r,n,i,a){var o=md5(t+":"+r+":"+n);return e&&"md5-sess"===e.toLowerCase()?md5(o+":"+i+":"+a):o},u=/(^|,)\s*auth\s*($|,)/.test(i.qop)&&"auth",l=u&&"00000001",c=u&&uuid().replace(/-/g,""),f=s(i.algorithm,n.user,i.realm,n.pass,i.nonce,c),p=md5(e+":"+t),h=md5(u?f+":"+i.nonce+":"+l+":"+c+":"+u+":"+p:f+":"+i.nonce+":"+p),d={username:n.user,realm:i.realm,nonce:i.nonce,uri:t,qop:u,response:h,nc:l,cnonce:c,algorithm:i.algorithm,opaque:i.opaque};r=[];for(var m in d)d[m]&&("qop"===m||"nc"===m||"algorithm"===m?r.push(m+"="+d[m]):r.push(m+'="'+d[m]+'"'));return r="Digest "+r.join(", "),n.sentAuth=!0,r},Auth.prototype.onRequest=function(e,t,r,n){var o,i=this,a=i.request;void 0===n&&void 0===e?i.request.emit("error",new Error("no auth mechanism defined")):o=void 0!==n?i.bearer(n,r):i.basic(e,t,r),o&&a.setHeader("authorization",o)},Auth.prototype.onResponse=function(e){var t=this,r=t.request;if(!t.hasAuth||t.sentAuth)return null;var n=caseless(e.headers),i=n.get("www-authenticate"),a=i&&i.split(" ")[0].toLowerCase();switch(r.debug("reauth",a),a){case"basic":return t.basic(t.user,t.pass,!0);case"bearer":return t.bearer(t.bearerToken,!0);case"digest":return t.digest(r.method,r.path,i)}},exports.Auth=Auth;